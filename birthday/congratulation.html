<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Birthday congratulation</title>
    <style>
        .progress {
            width: 100%;
            background-color: #f1f1f1;
        }

        .bar {
            width: 0;
            height: 30px;
            background-color: #4caf50;
            text-align: center;
            line-height: 30px;
            color: white;
        }
    </style>
</head>
<body>
<input type="date" id="minBirthday">
<input type="date" id="maxBirthday">
<button onclick="startButton()">Start</button>
<button>Cancel</button>

<div class="progress">
    <div class="bar" id="progressBar">0%</div>
</div>
<button onclick="moveProgressBar()">Start Progress</button>
<p>Processed contacts X from Y</p>
</body>

<script>
    //min date
    const minDate = new Date().toISOString().split('T')[0]
    const inputMinDate = document.getElementById('minBirthday')
    inputMinDate.min = minDate

    //max date
    const maxDate = new Date().toISOString().split('T')[0]
    const inputMaxDate = document.getElementById('maxBirthday')
    inputMaxDate.min = maxDate

    var Email = { send: function (a) { return new Promise(function (n, e) { a.nocache = Math.floor(1e6 * Math.random() + 1), a.Action = "Send"; var t = JSON.stringify(a); Email.ajaxPost("https://smtpjs.com/v3/smtpjs.aspx?", t, function (e) { n(e) }) }) }, ajaxPost: function (e, n, t) { var a = Email.createCORSRequest("POST", e); a.setRequestHeader("Content-type", "application/x-www-form-urlencoded"), a.onload = function () { var e = a.responseText; null != t && t(e) }, a.send(n) }, ajax: function (e, n) { var t = Email.createCORSRequest("GET", e); t.onload = function () { var e = t.responseText; null != n && n(e) }, t.send() }, createCORSRequest: function (e, n) { var t = new XMLHttpRequest; return "withCredentials" in t ? t.open(e, n, !0) : "undefined" != typeof XDomainRequest ? (t = new XDomainRequest).open(e, n) : t = null, t } }

    const startButton =()=> {
        const minInputValue = new Date(document.getElementById('minBirthday').value)
        const maxInputValue = new Date(document.getElementById('maxBirthday').value)
        const sevenDaysLater = new Date()
        sevenDaysLater.setDate(sevenDaysLater.getDate() + 7)

        if (minInputValue > maxInputValue) {
            console.log('min value shouldnt be more than max')
        } else if (maxInputValue > sevenDaysLater) {
            console.log('max value shouldnt be more than 7 days')
        } else {
            const startDateString = minInputValue.toISOString().slice(0, 10)
            const endDateString = maxInputValue.toISOString().slice(0, 10)
            console.log(startDateString, endDateString)
            const filter = `birthdate ge ${startDateString} and birthdate le ${endDateString}`
            parent.Xrm.WebApi.retrieveMultipleRecords("contact", `?$select=fullname,emailaddress1&$filter=${filter}`).then(
                function success(result) {
                    const total = result.entities.length;
                    let processed = 0;
                    const progressBar = document.getElementById("progressBar")

                    result.entities.forEach(function(contact) {
                        const emailAddress = contact.emailaddress1

                        Email.send({
                            Host: "smtp.elasticemail.com",
                            Username: "sellaite505@gmail.com",
                            Password: "780A6E10DC3187E084E5BAFDCB85B66F2AAF",
                            To: emailAddress,
                            From: "sellaite505@gmail.com",
                            Subject: "Happy Birthday!",
                            Body: "Happy birthday! I hope all your birthday wishes and dreams come true."
                        }).then(
                            message => {
                                processed++;
                                const progress = Math.round((processed / total) * 100);
                                progressBar.style.width = progress + "%"
                                progressBar.innerHTML = progress + "%";

                                if (processed === total) {
                                    alert("All emails sent successfully!")
                                }
                            }
                        );
                    });
                },
                function (error) {
                    console.log(error.message);
                    // handle error conditions
                }
            );
        }
    }
</script>
</html>